name: Build and Release Electron App

on:
    workflow_dispatch:
        inputs:
            allowed_websites:
                description: "Comma-separated list of allowed websites"
                required: true
                default: "https://google.com,https://github.com"
            app_name:
                description: "Application name"
                required: false
                default: "WEAP Browser"
            release_tag:
                description: "Release tag (leave empty for no release)"
                required: false
                default: ""

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, windows-latest, ubuntu-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 8

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install

            - name: Build TypeScript
              run: pnpm run build

            - name: Build Electron app (macOS)
              if: matrix.os == 'macos-latest'
              run: pnpm run dist:mac
              env:
                  ALLOWED_WEBSITES: ${{ github.event.inputs.allowed_websites }}
                  APP_NAME: ${{ github.event.inputs.app_name }}

            - name: Build Electron app (Windows)
              if: matrix.os == 'windows-latest'
              run: pnpm run dist:win
              env:
                  ALLOWED_WEBSITES: ${{ github.event.inputs.allowed_websites }}
                  APP_NAME: ${{ github.event.inputs.app_name }}

            - name: Build Electron app (Linux)
              if: matrix.os == 'ubuntu-latest'
              run: pnpm run dist:linux
              env:
                  ALLOWED_WEBSITES: ${{ github.event.inputs.allowed_websites }}
                  APP_NAME: ${{ github.event.inputs.app_name }}

            - name: Upload installers (macOS)
              if: matrix.os == 'macos-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: macos-installers
                  path: |
                      dist-electron/*.dmg

            - name: Upload portable (macOS)
              if: matrix.os == 'macos-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: macos-portable
                  path: |
                      dist-electron/*.zip

            - name: Upload installers (Windows)
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: windows-installers
                  path: |
                      dist-electron/*.exe
                      dist-electron/*.msi

            - name: Upload portable (Windows)
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: windows-portable
                  path: |
                      dist-electron/*-portable.exe

            - name: Upload installers (Linux)
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: linux-installers
                  path: |
                      dist-electron/*.deb
                      dist-electron/*.rpm

            - name: Upload portable (Linux)
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: linux-portable
                  path: |
                      dist-electron/*.AppImage

    release:
        if: github.event.inputs.release_tag != ''
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.event.inputs.release_tag }}
                  name: WEAP Browser ${{ github.event.inputs.release_tag }}
                  body: |
                      ## WEAP Browser Release ${{ github.event.inputs.release_tag }}

                      **Allowed Websites:** ${{ github.event.inputs.allowed_websites }}
                      **App Name:** ${{ github.event.inputs.app_name }}

                      ### Downloads

                      **macOS:**
                      - DMG installer (Intel & Apple Silicon)
                      - ZIP portable (Intel & Apple Silicon)

                      **Windows:**
                      - NSIS installer (x64, x86, ARM64)
                      - Portable executable (x64, x86, ARM64)

                      **Linux:**
                      - AppImage portable (x64, ARM64)
                      - DEB package (x64, ARM64)
                      - RPM package (x64, ARM64)

                      ### Installation Instructions

                      **macOS:** Download and open the DMG file, then drag the app to Applications folder. For portable version, extract and run the app directly.
                      **Windows:** Download and run the installer, or use the portable version directly.
                      **Linux:** Download the AppImage and make it executable, or install the DEB/RPM package.

                  files: |
                      macos-installers/*
                      macos-portable/*
                      windows-installers/*
                      windows-portable/*
                      linux-installers/*
                      linux-portable/*
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
